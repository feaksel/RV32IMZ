# CSR and Trap Handling Architecture Overview

**Visual Guide to CSR, Exceptions, and Interrupts**

---

## Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       RISC-V Core (RV32IM)                              â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Pipeline Control                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚  â”‚  â”‚  FETCH  â”‚â”€â”€â–¶â”‚ DECODE  â”‚â”€â”€â–¶â”‚ EXECUTE â”‚â”€â”€â–¶â”‚   WB    â”‚         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚  â”‚       â”‚             â”‚             â”‚                              â”‚  â”‚
â”‚  â”‚       â”‚             â”‚             â”‚                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚             â”‚             â”‚                                 â”‚
â”‚          â”‚             â”‚             â”‚                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚          Exception Detection                 â”‚                     â”‚
â”‚   â”‚                                               â”‚                     â”‚
â”‚   â”‚  â€¢ Illegal instruction                       â”‚                     â”‚
â”‚   â”‚  â€¢ Address misaligned                        â”‚                     â”‚
â”‚   â”‚  â€¢ Access fault                              â”‚                     â”‚
â”‚   â”‚  â€¢ ECALL / EBREAK                            â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                      â”‚ exception_taken                                 â”‚
â”‚                      â”‚ exception_cause                                 â”‚
â”‚                      â”‚                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚       Trap Control State Machine             â”‚                     â”‚
â”‚   â”‚                                               â”‚                     â”‚
â”‚   â”‚  Normal â†’ Exception â†’ TRAP â†’ Handler         â”‚                     â”‚
â”‚   â”‚             â”‚                                 â”‚                     â”‚
â”‚   â”‚         Interrupt â”€â”€â”€â”€â”˜                      â”‚                     â”‚
â”‚   â”‚                                               â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                      â”‚ trap_entry / trap_return                        â”‚
â”‚                      â”‚                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚            CSR Unit                           â”‚                     â”‚
â”‚   â”‚                                               â”‚                     â”‚
â”‚   â”‚  â€¢ Save PC â†’ mepc                            â”‚                     â”‚
â”‚   â”‚  â€¢ Save cause â†’ mcause                       â”‚                     â”‚
â”‚   â”‚  â€¢ Disable interrupts (MIE â† 0)              â”‚                     â”‚
â”‚   â”‚  â€¢ Provide trap_vector                       â”‚                     â”‚
â”‚   â”‚  â€¢ Performance counters                      â”‚                     â”‚
â”‚   â”‚                                               â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚      Interrupt Controller                     â”‚                     â”‚
â”‚   â”‚                                               â”‚                     â”‚
â”‚   â”‚  Priority: External > Software > Timer       â”‚                     â”‚
â”‚   â”‚                                               â”‚                     â”‚
â”‚   â”‚  Inputs: timer_int, external_int, etc.      â”‚                     â”‚
â”‚   â”‚  Output: interrupt_req, interrupt_cause      â”‚                     â”‚
â”‚   â”‚                                               â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                               â”‚
           â”‚ External Interrupts                          â”‚
           â”‚                                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚    Timer    â”‚  â”‚   ADC    â”‚  â”‚   PWM    â”‚  â”‚   Memory    â”‚
    â”‚  Peripheral â”‚  â”‚Interface â”‚  â”‚Acceleratorâ”‚  â”‚  (Wishbone) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Trap Flow Diagram

### Exception Flow (Synchronous)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Normal Execution                              â”‚
â”‚                                                                  â”‚
â”‚  PC = 0x1000  â†’  Fetch instruction  â†’  Decode  â†’  Execute      â”‚
â”‚                                                        â”‚         â”‚
â”‚                                                        â”‚         â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”‚
â”‚                                              â”‚  Illegal Inst  â”‚   â”‚
â”‚                                              â”‚   Detected!    â”‚   â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â”‚ exception_taken = 1
                                                       â”‚ exception_cause = 2
                                                       â”‚
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚  CSR Unit      â”‚
                                              â”‚  Trap Entry    â”‚
                                              â”‚                â”‚
                                              â”‚  mepc â† PC     â”‚
                                              â”‚  mcause â† 2    â”‚
                                              â”‚  MIE â† 0       â”‚
                                              â”‚  MPIE â† old MIEâ”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚ trap_vector
                                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Exception Handler                   â”‚           â”‚
â”‚                                                      â”‚           â”‚
â”‚  PC = trap_vector  â†’  Save registers (if needed)    â”‚           â”‚
â”‚                    â†’  Handle exception               â”‚           â”‚
â”‚                    â†’  Restore registers              â”‚           â”‚
â”‚                    â†’  Execute MRET                   â”‚           â”‚
â”‚                                        â”‚             â”‚           â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”       â”‚           â”‚
â”‚                              â”‚  CSR Unit      â”‚       â”‚           â”‚
â”‚                              â”‚  Trap Return   â”‚       â”‚           â”‚
â”‚                              â”‚                â”‚       â”‚           â”‚
â”‚                              â”‚  PC â† mepc     â”‚       â”‚           â”‚
â”‚                              â”‚  MIE â† MPIE    â”‚       â”‚           â”‚
â”‚                              â”‚  MPIE â† 1      â”‚       â”‚           â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚           â”‚
â”‚                                       â”‚               â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                        â”‚                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Resume Execution                               â”‚
â”‚                                                                   â”‚
â”‚  PC = 0x1000 (or wherever we want to go)                         â”‚
â”‚           â†’  Continue normal execution                            â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Interrupt Flow (Asynchronous)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Normal Execution                              â”‚
â”‚                                                                  â”‚
â”‚  PC = 0x1000  â†’  Fetch  â†’  Decode  â†’  Execute  â†’  ...          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Timer Peripheral              â”‚
    â”‚                                â”‚      10 kHz interrupt
    â”‚  Counter reaches threshold â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                                                  â”‚
                                                  â”‚ timer_int = 1
                                                  â”‚
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Interrupt         â”‚
                                         â”‚ Controller        â”‚
                                         â”‚                   â”‚
                                         â”‚ Check:            â”‚
                                         â”‚ - mie[7] = 1?     â”‚
                                         â”‚ - mstatus.MIE = 1?â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”‚ interrupt_req = 1
                                                  â”‚ interrupt_cause = 0x80000007
                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Core State Machine               â”‚               â”‚
â”‚                                                 â”‚               â”‚
â”‚  Check before next FETCH:                      â”‚               â”‚
â”‚    if (interrupt_req && !stall)                â”‚               â”‚
â”‚      â†’ Trap to interrupt handler               â”‚               â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                                        â”‚  CSR Unit      â”‚       â”‚
â”‚                                        â”‚  Trap Entry    â”‚       â”‚
â”‚                                        â”‚                â”‚       â”‚
â”‚                                        â”‚  mepc â† PC     â”‚       â”‚
â”‚                                        â”‚  mcause â† 0x87 â”‚       â”‚
â”‚                                        â”‚  MIE â† 0       â”‚       â”‚
â”‚                                        â”‚  MPIE â† 1      â”‚       â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                 â”‚ trap_vector   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Interrupt Handler                               â”‚
â”‚                                                                  â”‚
â”‚  PC = trap_vector  â†’  Save context                              â”‚
â”‚                    â†’  Read ADC values                            â”‚
â”‚                    â†’  Execute control algorithm                  â”‚
â”‚                    â†’  Update PWM duty cycles                     â”‚
â”‚                    â†’  Clear interrupt flag                       â”‚
â”‚                    â†’  Restore context                            â”‚
â”‚                    â†’  Execute MRET                               â”‚
â”‚                                        â”‚                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                   â”‚
â”‚                              â”‚  CSR Unit      â”‚                   â”‚
â”‚                              â”‚  Trap Return   â”‚                   â”‚
â”‚                              â”‚                â”‚                   â”‚
â”‚                              â”‚  PC â† mepc     â”‚                   â”‚
â”‚                              â”‚  MIE â† 1       â”‚                   â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                       â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Resume Execution                               â”‚
â”‚                                                                   â”‚
â”‚  PC = (whatever it was before interrupt)                         â”‚
â”‚           â†’  Continue where we left off                           â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CSR Register Organization

### Machine-Mode CSRs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Machine Information                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0xF11       â”‚ mvendorid     â”‚ Vendor ID (read-only)             â”‚
â”‚ 0xF12       â”‚ marchid       â”‚ Architecture ID (read-only)       â”‚
â”‚ 0xF13       â”‚ mimpid        â”‚ Implementation ID (read-only)     â”‚
â”‚ 0xF14       â”‚ mhartid       â”‚ Hardware thread ID (read-only)    â”‚
â”‚ 0x301       â”‚ misa          â”‚ ISA and extensions (read-only)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Machine Trap Setup                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x300       â”‚ mstatus       â”‚ Machine status register           â”‚
â”‚             â”‚               â”‚   [3] MIE: Global interrupt enableâ”‚
â”‚             â”‚               â”‚   [7] MPIE: Previous MIE          â”‚
â”‚             â”‚               â”‚   [12:11] MPP: Previous privilege â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x304       â”‚ mie           â”‚ Machine interrupt enable          â”‚
â”‚             â”‚               â”‚   [3] software int enable         â”‚
â”‚             â”‚               â”‚   [7] timer int enable            â”‚
â”‚             â”‚               â”‚   [11] external int enable        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x305       â”‚ mtvec         â”‚ Machine trap vector base address  â”‚
â”‚             â”‚               â”‚   [31:2] BASE: Handler address    â”‚
â”‚             â”‚               â”‚   [1:0] MODE: 0=direct, 1=vectoredâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Machine Trap Handling                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x340       â”‚ mscratch      â”‚ Scratch register for handlers     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x341       â”‚ mepc          â”‚ Machine exception program counter â”‚
â”‚             â”‚               â”‚   Saved PC when trap occurs       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x342       â”‚ mcause        â”‚ Machine trap cause                â”‚
â”‚             â”‚               â”‚   [31] Interrupt (1) or Exceptionâ”‚
â”‚             â”‚               â”‚   [30:0] Cause code               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x343       â”‚ mtval         â”‚ Machine trap value                â”‚
â”‚             â”‚               â”‚   Bad address or instruction      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x344       â”‚ mip           â”‚ Machine interrupt pending         â”‚
â”‚             â”‚               â”‚   [3] software int pending        â”‚
â”‚             â”‚               â”‚   [7] timer int pending           â”‚
â”‚             â”‚               â”‚   [11] external int pending       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Machine Counters/Timers                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0xB00       â”‚ mcycle        â”‚ Cycle counter (lower 32 bits)     â”‚
â”‚ 0xB80       â”‚ mcycleh       â”‚ Cycle counter (upper 32 bits)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0xB02       â”‚ minstret      â”‚ Instructions retired (lower 32)   â”‚
â”‚ 0xB82       â”‚ minstreth     â”‚ Instructions retired (upper 32)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Exception and Interrupt Codes

### Exception Codes (mcause[31] = 0)

```
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Code â”‚ Name                          â”‚ Description              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0   â”‚ Instruction address misalignedâ”‚ PC not 4-byte aligned    â”‚
â”‚  1   â”‚ Instruction access fault      â”‚ Fetch from bad address   â”‚
â”‚  2   â”‚ Illegal instruction           â”‚ Unknown/invalid opcode   â”‚
â”‚  3   â”‚ Breakpoint                    â”‚ EBREAK instruction       â”‚
â”‚  4   â”‚ Load address misaligned       â”‚ Misaligned LW/LH/LB      â”‚
â”‚  5   â”‚ Load access fault             â”‚ Load from bad address    â”‚
â”‚  6   â”‚ Store/AMO address misaligned  â”‚ Misaligned SW/SH/SB      â”‚
â”‚  7   â”‚ Store/AMO access fault        â”‚ Store to bad address     â”‚
â”‚  8   â”‚ Environment call from U-mode  â”‚ ECALL in user mode       â”‚
â”‚  9   â”‚ Environment call from S-mode  â”‚ ECALL in supervisor mode â”‚
â”‚ 11   â”‚ Environment call from M-mode  â”‚ ECALL in machine mode    â”‚
â”‚ 12   â”‚ Instruction page fault        â”‚ Virtual memory (not used)â”‚
â”‚ 13   â”‚ Load page fault               â”‚ Virtual memory (not used)â”‚
â”‚ 15   â”‚ Store/AMO page fault          â”‚ Virtual memory (not used)â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Interrupt Codes (mcause[31] = 1)

```
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Code â”‚ Name                          â”‚ mcause Value             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3   â”‚ Machine software interrupt    â”‚ 0x80000003               â”‚
â”‚  7   â”‚ Machine timer interrupt       â”‚ 0x80000007               â”‚
â”‚ 11   â”‚ Machine external interrupt    â”‚ 0x8000000B               â”‚
â”‚ 16+  â”‚ Platform-specific interrupts  â”‚ 0x80000010 + N           â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Transitions

### Normal Execution

```
       RESET
         â”‚
         â”‚ rst_n = 1
         â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”
      â”‚ FETCHâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â””â”€â”€â”€â”¬â”€â”€â”˜          â”‚
          â”‚             â”‚
          â”‚ instr ready â”‚
          â–¼             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”         â”‚
      â”‚ DECODEâ”‚         â”‚
      â””â”€â”€â”€â”¬â”€â”€â”€â”˜         â”‚
          â”‚             â”‚
          â”‚             â”‚
          â–¼             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
      â”‚ EXECUTEâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚
          â”‚             â”‚
          â”‚ if mem op   â”‚
          â–¼             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”          â”‚
      â”‚ MEM  â”‚          â”‚
      â””â”€â”€â”€â”¬â”€â”€â”˜          â”‚
          â”‚             â”‚
          â”‚             â”‚
          â–¼             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”         â”‚
      â”‚  WB   â”‚         â”‚
      â””â”€â”€â”€â”¬â”€â”€â”€â”˜         â”‚
          â”‚             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### With Trap Handling

```
       RESET
         â”‚
         â”‚ rst_n = 1
         â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”
      â”‚ FETCHâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â””â”€â”€â”€â”¬â”€â”€â”˜          â”‚
          â”‚             â”‚  interrupt_req = 1
          â”‚             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚             â”‚  â”‚                â”‚
          â–¼             â”‚  â–¼                â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”              â”‚
      â”‚ DECODEâ”‚      â”‚ TRAP â”‚              â”‚
      â””â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”¬â”€â”€â”€â”˜              â”‚
          â”‚             â”‚                   â”‚
          â”‚             â”‚ trap_entry = 1    â”‚
          â–¼             â”‚ PC â† trap_vector  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                   â”‚
      â”‚ EXECUTEâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚                   â”‚
          â”‚             â”‚ exception_taken=1 â”‚
          â”‚             â”‚                   â”‚
          â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”
      â”‚ MEM  â”‚
      â””â”€â”€â”€â”¬â”€â”€â”˜
          â”‚
          â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”
      â”‚  WB   â”‚
      â””â”€â”€â”€â”¬â”€â”€â”€â”˜
          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Interrupt Priority Logic

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Interrupt Priority Encoder                      â”‚
â”‚                                                              â”‚
â”‚  Input: mip (pending) & mie (enabled) & mstatus.MIE         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                                                     â”‚     â”‚
â”‚  â”‚  Priority (Highest to Lowest):                     â”‚     â”‚
â”‚  â”‚                                                     â”‚     â”‚
â”‚  â”‚  1. External Interrupt (bit 11)  â”€â”€â”€â”€â”€â”            â”‚     â”‚
â”‚  â”‚     mcause = 0x8000000B              â”‚            â”‚     â”‚
â”‚  â”‚                                       â”‚            â”‚     â”‚
â”‚  â”‚  2. Software Interrupt (bit 3)   â”€â”€â”€â”€â”¼â”€â”€â”€â”        â”‚     â”‚
â”‚  â”‚     mcause = 0x80000003              â”‚   â”‚        â”‚     â”‚
â”‚  â”‚                                       â”‚   â”‚        â”‚     â”‚
â”‚  â”‚  3. Timer Interrupt (bit 7)      â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”    â”‚     â”‚
â”‚  â”‚     mcause = 0x80000007              â”‚   â”‚   â”‚    â”‚     â”‚
â”‚  â”‚                                       â”‚   â”‚   â”‚    â”‚     â”‚
â”‚  â”‚  4. Platform-specific (bits 16-31)   â”‚   â”‚   â”‚    â”‚     â”‚
â”‚  â”‚     mcause = 0x80000000 | bit_number â”‚   â”‚   â”‚    â”‚     â”‚
â”‚  â”‚                                       â”‚   â”‚   â”‚    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”˜     â”‚
â”‚                                          â”‚   â”‚   â”‚          â”‚
â”‚                                          â–¼   â–¼   â–¼          â”‚
â”‚                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                                       â”‚   Priority   â”‚       â”‚
â”‚                                       â”‚     MUX      â”‚       â”‚
â”‚                                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                              â”‚               â”‚
â”‚                                              â”‚               â”‚
â”‚                                              â–¼               â”‚
â”‚                                    interrupt_cause           â”‚
â”‚                                    interrupt_req             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Timing Diagrams

### CSR Write (CSRRW)

```
Clock    : __|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__

PC       : 0x1000  | 0x1004  | 0x1008  | ...

Instr    : CSRRW x1, mstatus, x2

State    : FETCH   |DECODE   |EXECUTE  |  WB     |FETCH  ...

csr_addr :    X    | 0x300   | 0x300   | 0x300   |   X

csr_op   :    X    | 3'b001  | 3'b001  | 3'b001  |   X

csr_rdata:    X    |   OLD   |   OLD   |   OLD   |   X

csr_wdata:    X    |   NEW   |   NEW   |   NEW   |   X

x1       : OLD_VAL | OLD_VAL | OLD_VAL | OLD_CSR | OLD_CSR

mstatus  : OLD_CSR | OLD_CSR | NEW     | NEW     | NEW
```

### Exception Entry

```
Clock    : __|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__

PC       : 0x1000  | 0x1004  | 0x1008  | trap_vec| trap+4

Instr    : ADD     |ILLEGAL  |  ???    | Handler | Handler+

State    : FETCH   |DECODE   |EXECUTE  | TRAP    |FETCH

exception:    0    |    0    |    1    |    0    |   0
taken    :         |         | (detect)|         |

trap_    :    0    |    0    |    1    |    0    |   0
entry    :         |         |         |         |

mepc     :   ???   |   ???   |   ???   | 0x1004  | 0x1004

mcause   :   ???   |   ???   |   ???   |   0x02  | 0x02

mstatus  :         |         |         |         |
  .MIE   :    1    |    1    |    1    |    0    |   0
  .MPIE  :    1    |    1    |    1    |    1    |   1
```

### Interrupt Entry and Return

```
Clock    : __|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__|â€¾â€¾|__

PC       : 0x2000  | 0x2004  | trap_vec| trap+4  | ...   | 0x2008

Instr    : ADD     | SUB     | Handler | Handler+| MRET  | (resume)

State    : FETCH   |DECODE   | TRAP    |FETCH    | ...   |FETCH

interrupt:    0    |    1    |    0    |    0    |   0   |   0
_req     :         | (timer) |         |         |       |

trap_    :    0    |    1    |    0    |    0    |   0   |   0
entry    :         |         |         |         |       |

trap_    :    0    |    0    |    0    |    0    |   1   |   0
return   :         |         |         |         |(MRET) |

mepc     :   ???   | 0x2004  | 0x2004  | 0x2004  |0x2004 | 0x2004

mcause   :   ???   |0x800007 |0x800007 |0x800007 |0x800007|0x800007

mstatus  :         |         |         |         |       |
  .MIE   :    1    |    0    |    0    |    0    |   1   |   1
  .MPIE  :    0    |    1    |    1    |    1    |   1   |   1
```

---

## Module Interconnections

### CSR Unit Connections

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CSR Unit                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  INPUTS:                                                      â”‚
â”‚    clk, rst_n                    (Clock and reset)           â”‚
â”‚    csr_addr[11:0]               â—„â”€â”€â”€ Decoder                 â”‚
â”‚    csr_wdata[31:0]              â—„â”€â”€â”€ Register File (rs1)     â”‚
â”‚    csr_op[2:0]                  â—„â”€â”€â”€ Decoder                 â”‚
â”‚    trap_entry                   â—„â”€â”€â”€ State Machine           â”‚
â”‚    trap_return                  â—„â”€â”€â”€ State Machine (MRET)    â”‚
â”‚    trap_pc[31:0]                â—„â”€â”€â”€ PC                      â”‚
â”‚    trap_cause[31:0]             â—„â”€â”€â”€ Exception/Interrupt     â”‚
â”‚    trap_val[31:0]               â—„â”€â”€â”€ Exception Unit          â”‚
â”‚    interrupts_i[31:0]           â—„â”€â”€â”€ Interrupt Controller    â”‚
â”‚    instr_retired                â—„â”€â”€â”€ State Machine           â”‚
â”‚                                                               â”‚
â”‚  OUTPUTS:                                                     â”‚
â”‚    csr_rdata[31:0]              â”€â”€â”€â–º Register File (rd)      â”‚
â”‚    csr_valid                    â”€â”€â”€â–º Decoder                 â”‚
â”‚    trap_vector[31:0]            â”€â”€â”€â–º PC                      â”‚
â”‚    epc_out[31:0]                â”€â”€â”€â–º PC (for MRET)           â”‚
â”‚    interrupt_pending            â”€â”€â”€â–º State Machine           â”‚
â”‚    interrupt_enabled            â”€â”€â”€â–º State Machine           â”‚
â”‚    interrupt_cause[31:0]        â”€â”€â”€â–º State Machine           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Complete Core with Trap Handling

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Peripherals  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ interrupts
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Interrupt       â”‚
                    â”‚   Controller       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ interrupt_req
                            â”‚ interrupt_cause
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RISC-V Core                              â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Fetch  â”‚â”€â”€â–ºâ”‚ Decode â”‚â”€â”€â–ºâ”‚ Execute  â”‚â”€â”€â–ºâ”‚   WB    â”‚     â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚      â”‚             â”‚              â”‚                         â”‚
â”‚      â”‚             â”‚ is_csr       â”‚ exception_taken         â”‚
â”‚      â”‚             â”‚ csr_addr     â”‚ exception_cause         â”‚
â”‚      â”‚             â”‚ csr_op       â”‚                         â”‚
â”‚      â”‚             â”‚              â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                                               â”‚           â”‚
â”‚  â”‚           State Machine / Control            â”‚           â”‚
â”‚  â”‚                                               â”‚           â”‚
â”‚  â”‚  â€¢ Check interrupts before fetch             â”‚           â”‚
â”‚  â”‚  â€¢ Check exceptions after execute            â”‚           â”‚
â”‚  â”‚  â€¢ Handle trap entry                         â”‚           â”‚
â”‚  â”‚  â€¢ Handle trap return (MRET)                 â”‚           â”‚
â”‚  â”‚                                               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚ trap_entry             â”‚ PC control               â”‚
â”‚         â”‚ trap_return            â”‚                          â”‚
â”‚         â”‚                        â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                                               â”‚           â”‚
â”‚  â”‚              CSR Unit                         â”‚           â”‚
â”‚  â”‚                                               â”‚           â”‚
â”‚  â”‚  â€¢ mstatus, mie, mip                         â”‚           â”‚
â”‚  â”‚  â€¢ mtvec, mepc, mcause, mtval                â”‚           â”‚
â”‚  â”‚  â€¢ mcycle, minstret                          â”‚           â”‚
â”‚  â”‚                                               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

### Key Takeaways

1. **CSR Unit** manages system state and trap handling
2. **Exceptions** are synchronous (detected during execution)
3. **Interrupts** are asynchronous (checked before fetch)
4. **Priority** matters: external > software > timer
5. **Trap Entry** saves state and jumps to handler
6. **Trap Return** (MRET) restores state and resumes execution
7. **Integration** requires careful state machine design

### Implementation Order

1. âœ… CSR Unit (registers and operations)
2. âœ… Exception Detection (illegal instruction, misaligned, etc.)
3. âœ… Interrupt Controller (priority encoding)
4. âœ… Trap Entry Logic (save state, jump to handler)
5. âœ… Trap Return Logic (MRET, restore state)
6. âœ… System Instructions (CSRRW/RS/RC, ECALL, EBREAK)
7. âœ… Integration (connect all modules to core)
8. âœ… Testing (unit tests, integration tests, compliance)

### Next Steps

Refer to:
- [CSR_AND_COMPLIANCE_GUIDE.md](CSR_AND_COMPLIANCE_GUIDE.md) for detailed implementation
- [CSR_QUICK_CHECKLIST.md](CSR_QUICK_CHECKLIST.md) for progress tracking

**Good luck with your implementation!** ðŸš€

---

**Document Version:** 1.0
**Last Updated:** 2025-12-08
**Author:** Custom RISC-V Core Team
